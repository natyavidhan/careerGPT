{% extends 'base.html' %}
{% block title %}
    Saved Roadmaps - CareerGPT
{% endblock %} 
{% block content %}
    <div class="container">
        <h1 class="main-title">Your Saved Roadmaps</h1>
        <p class="subtitle">Access your career paths anytime</p>
        
        <div id="no-saved" class="no-saved" style="display: none;">
            <div class="empty-state">
                <i class="fas fa-bookmark empty-icon"></i>
                <h3>No saved roadmaps yet</h3>
                <p>When you save career roadmaps, they will appear here.</p>
                <a href="/" class="primary-btn">Explore Careers</a>
            </div>
        </div>
        
        <div id="saved-roadmaps" class="saved-roadmaps">
            <!-- Saved roadmaps will be loaded here -->
        </div>
        
        <div id="selected-roadmap" class="roadmap-container" style="display: none;">
            <!-- Selected roadmap will be displayed here -->
        </div>
        
        <!-- Skill Gap Modal -->
        <div id="skill-gap-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-puzzle-piece"></i> Your Skill Gap Analysis</h2>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <h3 id="skill-gap-career">Career Skill Gaps</h3>
                    
                    <div class="skill-checklist" id="saved-skill-checklist">
                        <!-- Skill gaps will be inserted here dynamically -->
                    </div>
                    <div class="gap-analysis-footer">
                        <p><i class="fas fa-info-circle"></i> Check off skills as you learn them to track your progress.</p>
                        <p class="priority-legend">
                            <span class="priority-indicator p1"></span> High Priority
                            <span class="priority-indicator p2"></span> Medium Priority
                            <span class="priority-indicator p3"></span> Standard Priority
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const noSavedElement = document.getElementById('no-saved');
            const savedRoadmapsElement = document.getElementById('saved-roadmaps');
            const selectedRoadmapElement = document.getElementById('selected-roadmap');
            const skillGapModal = document.getElementById('skill-gap-modal');
            const modalClose = document.querySelector('.modal-close');
            const skillGapCareer = document.getElementById('skill-gap-career');
            const savedSkillChecklist = document.getElementById('saved-skill-checklist');
            
            // Close modal when clicking the X button
            modalClose.addEventListener('click', function() {
                skillGapModal.style.display = 'none';
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                if (event.target == skillGapModal) {
                    skillGapModal.style.display = 'none';
                }
            });
            
            // Load skill gap checklist from localStorage
            function loadSkillGapProgress(career) {
                const skillGaps = JSON.parse(localStorage.getItem(`skillGap_${career}`) || '{}');
                return skillGaps;
            }
            
            // Save skill gap checklist to localStorage
            function saveSkillGapProgress(career, skillId, isChecked) {
                let skillGaps = loadSkillGapProgress(career);
                skillGaps[skillId] = isChecked;
                localStorage.setItem(`skillGap_${career}`, JSON.stringify(skillGaps));
            }
            
            // Display saved skill gap analysis
            function displaySkillGapAnalysis(career) {
                const skillGapData = JSON.parse(localStorage.getItem(`skillGapData_${career}`));
                
                if (!skillGapData) {
                    alert('No skill gap data found for this career');
                    return;
                }
                
                // Set the career name in the modal
                skillGapCareer.textContent = `${career} Skill Gaps`;
                
                // Clear previous results
                savedSkillChecklist.innerHTML = '';
                
                // Get saved progress
                const savedProgress = loadSkillGapProgress(career);
                
                // Create checklist items
                skillGapData.missing_skills.forEach((skill, index) => {
                    const skillId = `skill_${index}`;
                    const isChecked = savedProgress[skillId] || false;
                    
                    const listItem = document.createElement('div');
                    listItem.className = `skill-item priority-${skill.priority}`;
                    
                    listItem.innerHTML = `
                        <label class="skill-checkbox">
                            <input type="checkbox" id="${skillId}" ${isChecked ? 'checked' : ''}>
                            <span class="checkmark"></span>
                            <div class="skill-details">
                                <div class="skill-name">${skill.skill}</div>
                                <div class="skill-description">${skill.description || ''}</div>
                            </div>
                        </label>
                    `;
                    
                    savedSkillChecklist.appendChild(listItem);
                    
                    // Add event listener to save checkbox state
                    const checkbox = listItem.querySelector(`#${skillId}`);
                    checkbox.addEventListener('change', function() {
                        saveSkillGapProgress(career, skillId, this.checked);
                    });
                });
                
                // Show modal
                skillGapModal.style.display = 'block';
            }
            
            // Load saved roadmaps from localStorage
            const savedRoadmaps = JSON.parse(localStorage.getItem('savedRoadmaps') || '[]');
            
            if (savedRoadmaps.length === 0) {
                // Show empty state if no saved roadmaps
                noSavedElement.style.display = 'block';
                savedRoadmapsElement.style.display = 'none';
            } else {
                // Create cards for saved roadmaps
                let savedHtml = '<div class="saved-grid">';
                
                savedRoadmaps.forEach((roadmap, index) => {
                    savedHtml += `
                        <div class="saved-card" data-index="${index}">
                            <h3>${roadmap.career}</h3>
                            <div class="saved-info">
                                <span>${roadmap.roadmap.length} steps</span>
                                <div class="saved-actions">
                                    ${roadmap.hasSkillGap ? `
                                    <button class="skill-gap-btn" data-career="${roadmap.career}" title="View Skill Gaps">
                                        <i class="fas fa-tasks"></i>
                                    </button>
                                    ` : ''}
                                    <button class="delete-btn" data-index="${index}" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="view-saved">
                                <i class="fas fa-eye"></i> View Roadmap
                            </div>
                        </div>
                    `;
                });
                
                savedHtml += '</div>';
                savedRoadmapsElement.innerHTML = savedHtml;
                
                // Add click events to saved roadmap cards
                const savedCards = document.querySelectorAll('.saved-card');
                savedCards.forEach(card => {
                    card.addEventListener('click', function(e) {
                        // Don't trigger if clicking buttons
                        if (e.target.closest('.delete-btn') || e.target.closest('.skill-gap-btn')) {
                            return;
                        }
                        
                        const index = this.getAttribute('data-index');
                        displayRoadmap(savedRoadmaps[index]);
                    });
                });
                
                // Add click events to skill gap buttons
                const skillGapButtons = document.querySelectorAll('.skill-gap-btn');
                skillGapButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const career = this.getAttribute('data-career');
                        displaySkillGapAnalysis(career);
                    });
                });
                
                // Add click events to delete buttons
                const deleteButtons = document.querySelectorAll('.delete-btn');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const index = this.getAttribute('data-index');
                        
                        if (confirm('Are you sure you want to delete this roadmap?')) {
                            // Remove from array and update localStorage
                            savedRoadmaps.splice(index, 1);
                            localStorage.setItem('savedRoadmaps', JSON.stringify(savedRoadmaps));
                            
                            // Refresh the page to show updated list
                            location.reload();
                        }
                    });
                });
            }
            
            // Function to display a selected roadmap
            function displayRoadmap(roadmap) {
                // Scroll to top first
                window.scrollTo(0, 0);
                
                // Create roadmap visualization
                let roadmapHtml = `
                    <div class="roadmap-header">
                        <h2><i class="fas fa-map-marked-alt"></i> Career Path: ${roadmap.career}</h2>
                        <p>Your saved roadmap to becoming a ${roadmap.career}</p>
                        ${roadmap.hasSkillGap ? `
                        <button id="view-skill-gaps" class="secondary-btn skill-gap-top-btn">
                            <i class="fas fa-tasks"></i> View Your Skill Gaps
                        </button>
                        ` : ''}
                    </div>
                    <div class="roadmap-timeline">
                `;
                
                roadmap.roadmap.forEach((step, index) => {
                    roadmapHtml += `
                        <div class="roadmap-step">
                            <div class="step-number">${index + 1}</div>
                            <div class="step-content">
                                <h3 class="step-phase">${step.phase}</h3>
                                <div class="step-duration">
                                    <i class="fas fa-clock"></i> ${step.duration}
                                </div>
                                <p class="step-goal">${step.goal}</p>
                            </div>
                        </div>
                    `;
                });
                
                roadmapHtml += `
                    </div>
                    <div class="roadmap-footer">
                        <p><i class="fas fa-lightbulb"></i> This roadmap is a guide - adapt it to your personal situation and goals.</p>
                        <button id="back-to-list" class="secondary-btn">
                            <i class="fas fa-arrow-left"></i> Back to Saved Roadmaps
                        </button>
                    </div>
                `;
                
                // Display the roadmap
                selectedRoadmapElement.innerHTML = roadmapHtml;
                savedRoadmapsElement.style.display = 'none';
                selectedRoadmapElement.style.display = 'block';
                
                // Add back button functionality
                document.getElementById('back-to-list').addEventListener('click', function() {
                    savedRoadmapsElement.style.display = 'block';
                    selectedRoadmapElement.style.display = 'none';
                });
                
                // Add skill gap button functionality if available
                if (roadmap.hasSkillGap) {
                    document.getElementById('view-skill-gaps').addEventListener('click', function() {
                        displaySkillGapAnalysis(roadmap.career);
                    });
                }
            }
        });
    </script>
{% endblock %}
